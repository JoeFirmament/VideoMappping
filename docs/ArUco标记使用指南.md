# ArUco 标记使用指南

本文档提供了关于 ArUco 标记在视频坐标映射系统中的使用方法、放置要求和注意事项，以确保标定的准确性和可靠性。

## 目录

- [ArUco 标记简介](#aruco-标记简介)
- [准备 ArUco 标记](#准备-aruco-标记)
  - [生成标记](#生成标记)
  - [打印标记](#打印标记)
- [标记放置详细指南](#标记放置详细指南)
  - [坐标系定义](#坐标系定义)
  - [标记原点说明](#标记原点说明)
  - [布局方案建议](#布局方案建议)
- [自动测量原理和步骤](#自动测量原理和步骤)
- [详细操作流程](#详细操作流程)
- [常见问题与解决方案](#常见问题与解决方案)
- [附录：标记模板和工具](#附录标记模板和工具)

## ArUco 标记简介

ArUco 标记是一种特殊设计的二维码标记，用于计算机视觉和增强现实应用。每个标记由黑白方块组成，具有唯一的 ID，使其易于被计算机视觉算法检测和识别。

在我们的视频坐标映射系统中，ArUco 标记用于自动建立图像坐标系和地面坐标系之间的映射关系，实现精确的坐标转换。

## 准备 ArUco 标记

### 生成标记

我们的系统使用 OpenCV 的 DICT_4X4_50 字典，其中包含 50 个不同的标记，每个标记由 4×4 的网格组成。您可以通过以下方式生成标记：

1. **使用在线生成器**：
   - 访问 [ArUco 标记生成器](https://chev.me/arucogen/)
   - 选择 "4×4" 字典
   - 选择标记 ID（从 0 到 49）
   - 设置标记尺寸（建议 100-200mm）
   - 点击生成并下载标记

2. **使用 OpenCV 脚本**：
   - 我们在 `/home/radxa/Qworkspace/VideoMapping/tools` 目录下提供了一个生成脚本
   - 运行以下命令生成标记：
   ```bash
   python3 generate_aruco_markers.py --dict=DICT_4X4_50 --id=0 --size=200
   ```
   - 参数说明：
     - `--dict`：标记字典，使用 DICT_4X4_50
     - `--id`：标记 ID，从 0 到 49
     - `--size`：标记尺寸（像素）

3. **使用附录中的模板**：
   - 在本文档的[附录](#附录标记模板和工具)中提供了常用标记的 PDF 模板
   - 直接下载并打印这些模板

### 打印标记

正确打印 ArUco 标记对于检测精度至关重要：

1. **打印设置**：
   - 使用高质量的打印机，确保黑白对比度高
   - 选择“高质量”或“照片”打印模式
   - 不要缩放标记，保持原始尺寸

2. **纸张选择**：
   - 使用不反光的白纸（如普通 A4 打印纸）
   - 避免使用有光泽的纸张
   - 纸张重量应至少为 80g/m²，以确保硬度

3. **标记尺寸**：
   - 标记的实际物理尺寸应根据摄像头与地面的距离决定
   - 对于大多数应用，我们建议：
     - 摄像头高度 < 2米：使用 10cm × 10cm 的标记
     - 摄像头高度 2-4米：使用 15cm × 15cm 的标记
     - 摄像头高度 > 4米：使用 20cm × 20cm 或更大的标记

4. **打印后处理**：
   - 将标记粘贴在硬纸板或泡沙板上，以防止变形
   - 如需要长期使用，可以考虑将标记塑封或覆盖透明保护膜
   - 确保标记四周留有至少 1cm 的白色边距

## 标记放置详细指南

### 坐标系定义

在使用 ArUco 标记进行标定之前，需要明确定义地面坐标系：

1. **原点选择**：
   - 选择场地中一个固定的参考点作为坐标系原点(0,0)
   - 建议选择场地的一角或有明显标记的位置
   - 原点应在摄像头视野范围内，但不必在视野中心

2. **坐标轴方向**：
   - X 轴：通常与场地的一个主要边界平行（如墙壁或地板线）
   - Y 轴：与 X 轴垂直，形成右手坐标系
   - 正方向：两个轴的正方向应指向场地内部

3. **坐标单位**：
   - 定义清楚的测量单位，通常使用厘米(cm)
   - 确保所有测量和记录都使用相同的单位

4. **实物标记**：
   - 在实际场地上用胶带或水性笔标记出坐标轴和原点
   - 如条件允许，可以在地面上画出网格线，便于参考

### 标记原点说明

每个 ArUco 标记本身也有一个原点，这对于准确测量地面坐标非常重要：

1. **标记原点定义**：
   - ArUco 标记的原点定义为标记的几何中心
   - 在测量时，应从标记中心点到地面坐标系原点进行测量

2. **测量方法**：
   - 使用卷尺或激光测距仪测量标记中心到坐标原点的距离
   - 先测量 X 轴方向的距离，再测量 Y 轴方向的距离
   - 记录每个标记的 ID 和对应的地面坐标(x, y)

3. **标记方向**：
   - ArUco 标记的方向不影响中心点的定位
   - 但为了便于管理，建议所有标记保持相同的方向（如 ID 码均向上）

4. **记录表格**：
   - 使用下面的格式记录每个标记的信息：

   | 标记 ID | X 坐标 (cm) | Y 坐标 (cm) | 备注 |
   |------------|--------------|--------------|------|
   | 0          | 0            | 0            | 原点 |
   | 1          | 100          | 0            | X 轴上点 |
   | 2          | 0            | 100          | Y 轴上点 |
   | 3          | 100          | 100          | 第一象限点 |
   | ...        | ...          | ...          | ... |

### 布局方案建议

下面提供几种常用的 ArUco 标记布局方案：

1. **矩形网格布局**（推荐）：
   - 在场地上布置 3×3 或 4×4 的标记网格
   - 每个标记之间的间距相等（如 1 米或 1.5 米）
   - 优点：标定精度高，测量简单，坐标计算直观
   - 示例图：

   ```
   □ □ □ □
   □ □ □ □
   □ □ □ □
   □ □ □ □
   ```

2. **五点布局**：
   - 四角各放置一个标记，中心放置一个标记
   - 适用于较小的区域或标记数量有限的情况
   - 示例图：

   ```
   □     □
     □    
   □     □
   ```

3. **外围布局**：
   - 标记放置在场地的外围边缘
   - 适用于需要保持场地中心区域空时的情况
   - 示例图：

   ```
   □ □ □ □ □
   □         □
   □         □
   □         □
   □ □ □ □ □
   ```

无论选择哪种布局，请确保：

- 标记分布均匀，覆盖整个感兴趣区域
- 至少有 4 个标记可见，理想情况是 6-8 个
- 标记不要放置在可能被遗挡的区域
- 记录每个标记的准确地面坐标

## 自动测量原理和步骤

### 原理

1. **标记识别**：ArUco 标记具有独特的黑白方块图案，每个标记都有唯一的 ID。这种设计使得它们在各种光照条件下都易于检测。

2. **精确定位**：每个 ArUco 标记有四个角点，可以被精确定位，这为计算单应性矩阵提供了稳定的参考点。

3. **坐标映射**：通过建立图像坐标系和地面坐标系之间的映射关系（单应性矩阵），我们可以将标记在图像中的位置转换为实际地面坐标。

### 自动测量步骤

1. **准备 ArUco 标记**：
   - 打印多个 ArUco 标记（我们使用的是 DICT_4X4_50 字典中的标记）
   - 将标记放置在地面上的已知位置

2. **设置标记地面坐标**：
   - 为每个 ArUco 标记 ID 分配对应的地面坐标
   - 这些坐标可以通过手动测量获得，或使用预定义的网格布局

3. **标记检测**：
   - 系统自动检测视频帧中的 ArUco 标记
   - 提取每个标记的四个角点和中心点坐标

4. **自动标定**：
   - 使用检测到的标记中心点和预先设定的地面坐标
   - 至少需要 4 个标记点对来计算单应性矩阵
   - 系统自动计算图像坐标到地面坐标的转换关系

5. **坐标转换**：
   - 标定完成后，任何图像中的点都可以被转换为对应的地面坐标
   - 这包括其他 ArUco 标记、人物或物体的位置

## 标记放置要求

### 位置要求

1. **分布均匀**：
   - 标记应尽量分布在视野的不同区域，覆盖需要进行坐标转换的整个区域
   - 理想情况下，标记应形成一个凸多边形，包围整个感兴趣区域

2. **数量要求**：
   - 至少需要 4 个标记点对来计算单应性矩阵
   - 建议使用 6-8 个标记以提高精度和鲁棒性
   - 标记数量过多可能导致计算量增加，但通常不会影响精度

3. **坐标系定义**：
   - 需要预先定义地面坐标系的原点和坐标轴方向
   - 可以选择场景中的一个固定点作为原点（如场地一角）
   - 坐标轴通常与场地的自然边界平行（如墙壁、地板线条）

4. **测量精度**：
   - 标记的地面坐标需要准确测量
   - 可以使用卷尺、激光测距仪等工具测量
   - 测量误差会直接影响最终的坐标转换精度

### 放置注意事项

1. **平整放置**：
   - 标记应平整地放置在地面上，避免褶皱或弯曲
   - 如果地面不平，可以使用硬纸板或其他硬质材料作为底座

2. **固定牢固**：
   - 标记应固定牢固，防止移动或旋转
   - 可以使用胶带、重物或专用支架固定

3. **可见性**：
   - 标记必须完全可见，不能被遮挡
   - 避免放置在可能被人或物体遮挡的区域
   - 确保标记在摄像头视野范围内清晰可见

4. **光照条件**：
   - 避免强光直射标记，可能导致过曝或反光
   - 避免标记处于阴影中，可能导致检测困难
   - 尽量保持均匀的光照条件

5. **尺寸考虑**：
   - 标记尺寸应根据摄像头距离和分辨率选择
   - 太小的标记可能难以检测，太大的标记可能占用过多空间
   - 一般建议标记在图像中的尺寸至少为 20×20 像素

6. **标记方向**：
   - 标记的方向不会影响检测，但会影响 ID 的识别
   - 建议所有标记保持相同的朝向，便于调试和理解

7. **标记间距**：
   - 标记之间应保持足够的间距，避免相互干扰
   - 间距应根据实际场景和摄像头视野调整

### 实用建议

1. **使用标准网格**：
   - 可以预先设计一个标准网格，标记放置在网格的交点上
   - 这样可以简化坐标测量，提高精度

2. **使用不同 ID**：
   - 使用不同 ID 的标记，便于系统区分
   - ID 编号可以按照位置顺序编排，便于管理

3. **记录标记位置**：
   - 详细记录每个标记的 ID 和对应的地面坐标
   - 可以绘制标记布局图，便于后续参考

4. **测试验证**：
   - 完成标定后，应测试验证坐标转换的准确性
   - 可以在已知位置放置额外的标记进行验证

## 详细操作流程

下面是使用 ArUco 标记进行自动标定的完整操作流程，包含每一步的详细说明：

### 1. 准备阶段

#### 1.1 标记准备

1. **生成标记**：
   - 使用本文档前面提到的方法生成 ArUco 标记
   - 建议生成 ID 从 0 到 8 的标记（共 9 个）
   - 标记尺寸根据摄像头高度选择，通常 10-20cm 边长

2. **打印和加固**：
   - 使用高质量打印机打印标记
   - 将标记粘贴在硬纸板或泡沙板上
   - 每个标记四周留出至少 1cm 的白色边距

#### 1.2 坐标系准备

1. **定义地面坐标系**：
   - 选择场地一角作为原点(0,0)
   - 使用胶带或水性笔在地面标记原点位置
   - 确定 X 轴和 Y 轴方向，并在地面上标记

2. **布置标记**：
   - 根据选定的布局方案（如矩形网格）放置标记
   - 确保标记平整放置在地面上
   - 使用胶带或小的重物固定标记，防止移动

3. **测量坐标**：
   - 使用卷尺或激光测距仪测量每个标记中心到原点的距离
   - 先测 X 轴方向距离，再测 Y 轴方向距离
   - 在表格中记录每个标记的 ID 和对应坐标
   - 例如：

   | 标记 ID | X 坐标 (cm) | Y 坐标 (cm) |
   |------------|--------------|--------------|  
   | 0          | 0            | 0            |
   | 1          | 100          | 0            |
   | 2          | 200          | 0            |
   | 3          | 0            | 100          |
   | 4          | 100          | 100          |
   | 5          | 200          | 100          |
   | 6          | 0            | 200          |
   | 7          | 100          | 200          |
   | 8          | 200          | 200          |

4. **检查摄像头视野**：
   - 启动系统，确保摄像头视野能覆盖所有标记
   - 调整摄像头角度和高度，使所有标记清晰可见
   - 确保光线均匀，避免标记过曜或处于阴影中

### 2. 系统操作阶段

#### 2.1 启动系统

1. **启动视频流应用**：
   - 运行视频流应用程序
   - 在浏览器中访问应用界面（默认地址：http://localhost:8080）

2. **进入 ArUco 模式**：
   - 在界面上点击“启用 ArUco 模式”按钮
   - 系统将自动检测并显示视频中的 ArUco 标记
   - 每个标记旁边将显示其 ID 号

#### 2.2 输入标记坐标

1. **输入方式**：
   - 点击“设置标记坐标”按钮
   - 在弹出的表格中，为每个检测到的标记 ID 输入对应的 X 和 Y 坐标
   - 按照前面测量记录的数据输入

2. **加载已保存的坐标**（可选）：
   - 如果之前保存过标记坐标文件，可以点击“加载标记坐标”按钮
   - 选择保存的坐标文件（默认位置：/home/radxa/Qworkspace/VideoMapping/data/markers.xml）

#### 2.3 执行自动标定

1. **检查标记检测**：
   - 确认系统能检测到至少 4 个标记，理想情况下应有 6-8 个
   - 确认每个标记旁边都显示了正确的 ID 号

2. **执行标定**：
   - 点击“从 ArUco 标记标定”按钮
   - 系统将使用检测到的标记和已输入的地面坐标计算单应性矩阵
   - 标定成功后会显示“标定成功”的提示

3. **保存标定结果**：
   - 标定成功后，点击“保存标定结果”按钮
   - 系统将保存单应性矩阵和标记坐标到指定文件
   - 单应性矩阵默认保存到：/home/radxa/Qworkspace/VideoMapping/data/homography.xml
   - 标记坐标默认保存到：/home/radxa/Qworkspace/VideoMapping/data/markers.xml

### 3. 测试和验证阶段

#### 3.1 测试坐标转换

1. **退出标定模式**：
   - 点击“退出 ArUco 模式”按钮
   - 进入坐标测试模式

2. **点击测试**：
   - 在视频上点击任意位置
   - 系统将显示点击位置的图像坐标和转换后的地面坐标

3. **验证精度**：
   - 在地面上放置一个已知坐标的物体（如另一个 ArUco 标记）
   - 点击该物体在视频中的位置
   - 比较系统输出的地面坐标与实际坐标的差异

#### 3.2 调整和优化

1. **精度不足时的调整**：
   - 如果精度不满足要求，可以尝试以下方法：
     - 增加标记数量
     - 调整标记布局，使其更均匀分布
     - 重新测量标记坐标，确保测量准确
     - 改善光照条件，提高标记检测的稳定性

2. **再次标定**：
   - 调整后重复标定过程
   - 比较不同标定结果的精度
   - 选择最佳结果并保存

## 常见问题与解决方案

1. **标记无法检测**：
   - 检查光照条件，避免强光或阴影
   - 确保标记尺寸足够大，清晰可见
   - 检查标记是否平整，没有褻皮或损坏
   - 确保标记四周有足够的白色边距
   - 调整摄像头焦距，确保图像清晰

2. **标定精度不足**：
   - 增加标记数量，提高覆盖范围
   - 确保标记地面坐标测量准确
   - 检查是否有标记固定牢固，没有移动
   - 使用更均匀的标记布局，如矩形网格
   - 尝试使用更精确的测量工具，如激光测距仪

3. **坐标转换不准确**：
   - 验证标定结果，重新进行标定
   - 检查是否有标记坐标输入错误
   - 确保测试点在标记覆盖的区域内
   - 检查坐标系定义是否一致（原点位置、轴方向）
   - 如果距离标记过远的区域精度低，考虑在该区域添加额外标记

4. **系统性能问题**：
   - 减少视频分辨率，降低计算负担
   - 减少同时检测的标记数量
   - 优化光照条件，提高检测效率
   - 如果使用 RK3588 等高性能平台，可以启用 NPU 加速

5. **标记 ID 识别错误**：
   - 检查标记打印质量，确保黑白对比度高
   - 改善光照条件，避免光线不均
   - 使用更大尺寸的标记
   - 尝试使用不同的 ArUco 字典（如 DICT_5X5_50），可能有更好的识别率

6. **标定结果不稳定**：
   - 确保摄像头固定牢固，不会移动
   - 使用更多标记提高稳定性
   - 多次进行标定，取平均结果
   - 检查场地是否有振动或光照变化

## 附录：标记模板和工具

为了方便用户使用，我们提供了以下资源和工具：

### 1. ArUco 标记生成脚本

我们在项目中提供了一个 Python 脚本来生成 ArUco 标记。请将以下代码保存为 `/home/radxa/Qworkspace/VideoMapping/tools/generate_aruco_markers.py`：

```python
#!/usr/bin/env python3
import cv2
import numpy as np
import argparse
import os

def generate_aruco_marker(dictionary_name, marker_id, size, output_dir="."):
    """生成 ArUco 标记并保存为 PNG 文件
    
    Args:
        dictionary_name: ArUco 字典名称，如 'DICT_4X4_50'
        marker_id: 标记 ID，从 0 开始
        size: 生成的标记图像尺寸（像素）
        output_dir: 输出目录
    """
    # 选择 ArUco 字典
    ARUCO_DICT = {
        "DICT_4X4_50": cv2.aruco.DICT_4X4_50,
        "DICT_4X4_100": cv2.aruco.DICT_4X4_100,
        "DICT_5X5_50": cv2.aruco.DICT_5X5_50,
        "DICT_5X5_100": cv2.aruco.DICT_5X5_100,
        "DICT_6X6_50": cv2.aruco.DICT_6X6_50,
        "DICT_6X6_100": cv2.aruco.DICT_6X6_100,
        "DICT_7X7_50": cv2.aruco.DICT_7X7_50,
        "DICT_7X7_100": cv2.aruco.DICT_7X7_100
    }
    
    # 验证字典名称
    if dictionary_name not in ARUCO_DICT:
        print(f"Error: 不支持的字典 {dictionary_name}")
        print(f"可用的字典: {', '.join(ARUCO_DICT.keys())}")
        return False
    
    # 创建字典对象
    aruco_dict = cv2.aruco.Dictionary_get(ARUCO_DICT[dictionary_name])
    
    # 生成标记
    marker_image = np.zeros((size, size), dtype=np.uint8)
    marker_image = cv2.aruco.drawMarker(aruco_dict, marker_id, size, marker_image, 1)
    
    # 添加白色边距（标记周围的空白区域）
    border_size = size // 10  # 边距为标记尺寸的 10%
    bordered_image = np.ones((size + 2 * border_size, size + 2 * border_size), dtype=np.uint8) * 255
    bordered_image[border_size:border_size+size, border_size:border_size+size] = marker_image
    
    # 添加标记 ID 文本
    final_image = cv2.cvtColor(bordered_image, cv2.COLOR_GRAY2BGR)
    cv2.putText(final_image, f"ID: {marker_id}", (border_size, size + border_size * 2 - 10),
                cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 0), 1, cv2.LINE_AA)
    
    # 创建输出目录（如果不存在）
    os.makedirs(output_dir, exist_ok=True)
    
    # 保存标记图像
    filename = f"{output_dir}/aruco_{dictionary_name}_id{marker_id}_{size}px.png"
    cv2.imwrite(filename, final_image)
    print(f"标记已保存到: {filename}")
    
    return True

def main():
    # 解析命令行参数
    parser = argparse.ArgumentParser(description='ArUco 标记生成器')
    parser.add_argument('--dict', type=str, default='DICT_4X4_50',
                        help='ArUco 字典名称 (default: DICT_4X4_50)')
    parser.add_argument('--id', type=int, default=0,
                        help='标记 ID (default: 0)')
    parser.add_argument('--size', type=int, default=200,
                        help='标记尺寸（像素） (default: 200)')
    parser.add_argument('--output', type=str, default='.',
                        help='输出目录 (default: 当前目录)')
    parser.add_argument('--batch', action='store_true',
                        help='批量生成标记（从 0 到 --id）')
    
    args = parser.parse_args()
    
    if args.batch:
        # 批量生成标记
        for i in range(args.id + 1):
            generate_aruco_marker(args.dict, i, args.size, args.output)
    else:
        # 生成单个标记
        generate_aruco_marker(args.dict, args.id, args.size, args.output)

if __name__ == "__main__":
    main()
```

使用方法：

```bash
# 生成单个标记（ID为0）
$ python3 generate_aruco_markers.py --dict=DICT_4X4_50 --id=0 --size=200

# 批量生成标记（ID从0到9）
$ python3 generate_aruco_markers.py --dict=DICT_4X4_50 --id=9 --size=200 --batch
```

### 2. 标记坐标记录表格

下面是一个可打印的标记坐标记录表格，用于在现场测量时记录标记坐标：

```
+-----------------------------------------------+
|             ArUco 标记坐标记录表             |
+-----------------------------------------------+
| 日期：_____________ | 测量人员：_____________ |
| 场地：_____________ | 坐标单位：___(厘米)___ |
+-----------------------------------------------+
| 标记 ID | X 坐标 (cm) | Y 坐标 (cm) | 备注        |
+----------+---------------+---------------+-------------+
| 0        |               |               | 原点        |
+----------+---------------+---------------+-------------+
| 1        |               |               |             |
+----------+---------------+---------------+-------------+
| 2        |               |               |             |
+----------+---------------+---------------+-------------+
| 3        |               |               |             |
+----------+---------------+---------------+-------------+
| 4        |               |               |             |
+----------+---------------+---------------+-------------+
| 5        |               |               |             |
+----------+---------------+---------------+-------------+
| 6        |               |               |             |
+----------+---------------+---------------+-------------+
| 7        |               |               |             |
+----------+---------------+---------------+-------------+
| 8        |               |               |             |
+----------+---------------+---------------+-------------+
| 9        |               |               |             |
+----------+---------------+---------------+-------------+
| 坐标系定义：                                  |
| X 轴方向：___________________________________ |
| Y 轴方向：___________________________________ |
| 备注：________________________________________ |
+-----------------------------------------------+
```

### 3. 常用标记下载

我们已经预先生成了一组常用的 ArUco 标记，可以直接下载并打印使用。这些标记已保存在项目的 `/home/radxa/Qworkspace/VideoMapping/resources/markers` 目录下。

如果该目录不存在，可以使用上面提供的脚本生成标记，或者使用在线生成器：

- [ArUco 标记生成器](https://chev.me/arucogen/)
- [ArUco 标记生成器 2](https://emaraic.com/blog/aruco-markers-generation)

### 4. 其他有用的资源

- [OpenCV ArUco 模块文档](https://docs.opencv.org/4.x/d5/dae/tutorial_aruco_detection.html)
- [ArUco 标记实现详解](https://www.pyimagesearch.com/2020/12/21/detecting-aruco-markers-with-opencv-and-python/)
- [ArUco 标记库 GitHub 仓库](https://github.com/opencv/opencv_contrib/tree/master/modules/aruco)

---

通过遵循本指南的要求和建议，您可以有效地使用 ArUco 标记进行自动坐标映射，实现高精度的图像到地面坐标的转换。如果您有任何问题或需要进一步的帮助，请参考项目文档或联系技术支持团队。

---
