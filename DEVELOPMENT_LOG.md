# VideoMapping 项目开发日志

## 项目信息
- **开发平台**: Rock 5C (ARM64 架构)
- **操作系统**: Linux 6.1.43-15-rk2312
- **CPU类型**: ARM64 (RK3588s)
- **开发环境**: SSH远程开发

---

## 2024-12-19 - 单应性矩阵标定界面优化

### 🎯 **核心问题**
- 全屏按钮点击被误识别为图像点击事件
- 1920×1080分辨率保持对单应性矩阵计算精度至关重要
- 界面元素干扰标定过程

### ✅ **解决方案**
1. **移除视觉干扰元素**
   - 完全隐藏标定模式下的全屏按钮
   - 清理所有浮动覆盖控件
   - 保持画面完全洁净

2. **保留快捷键操作**
   - F11: 切换全屏模式
   - ESC: 退出全屏模式
   - 键盘操作不影响画面点击

3. **强化用户指导**
   - 强调1920×1080分辨率的重要性
   - 更新标定提示信息
   - 增强全屏模式的操作指导

### 🔧 **技术实现**
```javascript
// 标定模式下完全隐藏浮动元素
if (this.calibrationMode) {
    fullscreenContainer.style.display = 'none';
    videoOverlayControls.style.display = 'none';
}
```

### 📐 **分辨率保证措施**
- 明确标注1920×1080要求
- 在多个提示位置强调分辨率重要性
- 全屏模式提示显示分辨率信息

### 🎮 **用户体验改进**
- 完全洁净的标定画面
- 直观的快捷键操作
- 清晰的操作流程指导
- 减少误操作可能性

### ⚡ **性能优化**
- 减少DOM元素处理
- 简化事件监听
- 提高点击响应精度

---

## 2024-12-19 - 摄像头分辨率不匹配问题修复

### 🚨 **问题根源**
- **摄像头硬件限制**: 摄像头不支持1920x1080，只能运行在640x480
- **分辨率验证缺失**: 程序未正确检测分辨率设置失败
- **期望与现实不符**: 程序期望1920x1080但摄像头实际运行640x480
- **连续帧读取失败**: 分辨率不匹配导致OpenCV处理异常

### ✅ **修复措施**
1. **加强分辨率验证**
   - 严格检测分辨率设置是否成功
   - 当摄像头不支持目标分辨率时给出明确警告
   - 自动适配到摄像头实际支持的分辨率

2. **改进诊断信息**
   - 启动时检查摄像头支持的所有分辨率
   - 清晰显示分辨率设置过程
   - 区分期望分辨率和实际分辨率

3. **智能降级策略**
   - 当高分辨率不可用时自动降级
   - 保持系统稳定运行
   - 优化内存和性能

### 🔧 **代码变更**
```cpp
// 修复前: 静默失败
cap_.set(cv::CAP_PROP_FRAME_WIDTH, width);

// 修复后: 严格验证 + 自动适配
if (abs(actual_width - width) > 50) {
    cout << "⚠️ 分辨率不支持，自动调整";
    detectionWidth_ = actual_width;
}
```

---

## 2024-12-19 - OpenCV Mat对象异常修复

### 🐛 **致命Bug发现**
分辨率修复后出现新问题：
```
cv::Exception: Unknown array type in function 'cvarrToMat'
```

### 🕵️ **问题分析**
在双分辨率帧处理逻辑中：
```cpp
frame_ = std::move(processedFrame);  // frame移动后变空
frame.copyTo(detectionFrame_);       // 使用空的frame导致异常
```

### ✅ **修复方案**
```cpp
// 修复前：复杂的共享逻辑，容易出错
if (cameraCalibrationMode_) {
    frame.copyTo(detectionFrame_);  // frame已被move，为空
}

// 修复后：简化为安全的深度复制
frame_ = std::move(processedFrame);
detectionFrame_ = frame_.clone();   // 安全可靠
```

### 🎯 **测试结果**
- ✅ 分辨率正确设置为1920x1080
- ✅ 摄像头支持检测正常工作
- 🔄 等待验证Mat异常是否完全解决

---

## 下一步计划
- [ ] 测试OpenCV异常修复效果
- [ ] 验证ARM64平台性能改善
- [ ] 测试标定精度改进效果
- [ ] 验证快捷键操作流畅性
- [ ] 收集用户使用反馈

---

*最后更新: 2024-12-19* 