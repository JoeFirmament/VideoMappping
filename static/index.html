<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>边缘计算标定测试系统</title>
    
    <!-- 防缓存的meta标签 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <div class="page-header">
            <div class="language-switcher">
                <select id="languageSelect" class="language-select">
                    <option value="zh">中文</option>
                    <option value="en">English</option>
                </select>
            </div>
            <h1 class="page-title" data-i18n="title">边缘计算标定测试系统</h1>
            <p class="page-subtitle" data-i18n="subtitle">Edge Computing Calibration Test System</p>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title" data-i18n="video_monitoring">视频流</h2>
                <div id="status" class="status-panel" data-i18n="status_connecting">状态: 正在连接服务器...</div>
            </div>
            
            <div class="grid grid-2">
                <div>
                    <div class="video-container">
                        <img id="video" class="video-canvas" src="" data-i18n-alt="video_stream">
                        <div class="video-controls-overlay">
                            <button id="startBtn" class="btn btn-sm btn-primary" disabled>
                                <span data-i18n="start">开始</span>
                            </button>
                            <button id="stopBtn" class="btn btn-sm btn-danger" disabled>
                                <span data-i18n="stop">停止</span>
                            </button>
                            <button id="fullscreenBtn" class="btn btn-sm btn-secondary">
                                <span data-i18n="fullscreen">全屏</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label" data-i18n="fps">FPS</span>
                            <span id="fps" class="stat-value">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label" data-i18n="resolution">分辨率</span>
                            <span id="resolution" class="stat-value">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label" data-i18n="latency">帧间隔</span>
                            <span id="latency" class="stat-value">-</span>
                        </div>
                    </div>
                    
                    <!-- 标定参数设置区域 - 移到视频下方 -->
                    <div class="calibration-params-section">
                        <h4 class="mb-2" data-i18n="calibration_parameters">标定参数设置</h4>
                        
                        <!-- 两行参数布局 -->
                        <div class="parameter-rows">
                            <!-- 第一行：基础参数 -->
                            <div class="parameter-row">
                                <div class="form-group compact">
                                    <label class="form-label" data-i18n="corner_width">内角点宽度</label>
                                    <input type="number" id="boardWidthInput" value="8" class="form-control compact" min="3" max="20" />
                                </div>
                                <div class="form-group compact">
                                    <label class="form-label" data-i18n="corner_height">内角点高度</label>
                                    <input type="number" id="boardHeightInput" value="5" class="form-control compact" min="3" max="20" />
                                </div>
                                <div class="form-group compact">
                                    <label class="form-label" data-i18n="square_size">方格大小(mm)</label>
                                    <input type="number" id="squareSizeInput" value="30" class="form-control compact" min="5" max="200" />
                                </div>
                            </div>
                            
                            <!-- 第二行：高级参数 -->
                            <div class="parameter-row">
                                <div class="form-group compact">
                                    <label class="form-label" data-i18n="blur_kernel_size">高斯模糊核</label>
                                    <select id="blurKernelSizeInput" class="form-control compact">
                                        <option value="0" data-i18n="none">无</option>
                                        <option value="3">3×3</option>
                                        <option value="5" selected>5×5</option>
                                        <option value="7">7×7</option>
                                        <option value="9">9×9</option>
                                    </select>
                                </div>
                                <div class="form-group compact">
                                    <label class="form-label" data-i18n="quality_check_level">质量检测级别</label>
                                    <select id="qualityCheckLevelInput" class="form-control compact">
                                        <option value="0" data-i18n="strict_quality">严格</option>
                                        <option value="1" selected data-i18n="balanced_quality">平衡</option>
                                        <option value="2" data-i18n="permissive_quality">宽松</option>
                                    </select>
                                </div>
                                <div class="form-group compact">
                                    <button id="setBoardSizeBtn" class="btn btn-secondary btn-sm">
                                        <span data-i18n="apply_parameters">应用参数</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 标定状态信息 -->
                        <div class="calibration-status-info">
                            <div class="info-item">
                                <span class="info-label" data-i18n="current_session_images">当前会话:</span>
                                <span id="currentSessionImagesCount" class="info-value">0 张</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="saved_images_count">历史保存:</span>
                                <span id="savedImagesCount" class="info-value">0 张</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="reprojection_error">重投影误差:</span>
                                <span id="calibrationErrorDisplay" class="info-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-panel">
                    <div class="control-section compact">
                        <h3 class="mb-2" data-i18n="camera_settings">摄像头设置</h3>
                        <div class="resolution-info">
                            <div class="resolution-item">
                                <span class="info-label" data-i18n="display_resolution">显示分辨率:</span>
                                <span id="displayResolution" class="info-value">960×540</span>
                            </div>
                            <div class="resolution-item">
                                <span class="info-label" data-i18n="detection_resolution">检测分辨率:</span>
                                <span id="detectionResolution" class="info-value">1920×1080</span>
                            </div>
                            <div class="resolution-item">
                                <span class="info-label" data-i18n="performance_mode">性能模式:</span>
                                <span id="performanceMode" class="info-value status-dual">双分辨率</span>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="control-section">
                        <h3 class="mb-2" data-i18n="camera_intrinsic_calibration">相机内参标定</h3>
                        <p class="section-description compact" data-i18n="camera_calibration_desc">用于消除镜头畸变，提高测量精度</p>
                        
                        <!-- 标定流程说明 -->
                        <div class="calibration-flow-info">
                            <small class="flow-text" data-i18n="calibration_flow">
                                流程: 1.设置参数 → 2.进入标定模式 → 3.采集图片 → 4.执行标定 → 5.保存结果
                            </small>
                        </div>
                        
                        <!-- 标定操作按钮 - 简化布局 -->
                        <div class="calibration-operations mb-3">
                            <!-- 主要操作按钮 -->
                            <div class="control-row mb-2">
                                <button id="toggleCameraCalibrationBtn" class="btn btn-primary">
                                    <span data-i18n="camera_calibration_mode">相机标定模式</span>
                                </button>
                                <button id="addCalibrationImageBtn" class="btn btn-success" disabled>
                                    <span data-i18n="manual_capture_image">手动采集</span>
                                </button>
                            </div>
                            
                            <!-- 自动采集区域 -->
                            <div class="auto-capture-section mb-3">
                                <h5 data-i18n="auto_capture_settings">自动采集设置</h5>
                                <div class="control-row mb-2">
                                    <div class="form-group">
                                        <label class="form-label" data-i18n="auto_capture_time">时间(秒)</label>
                                        <input type="number" id="autoCaptureTimeInput" value="10" class="form-control compact" min="1" max="60" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" data-i18n="auto_capture_interval">间隔(毫秒)</label>
                                        <input type="number" id="autoCaptureIntervalInput" value="500" class="form-control compact" min="100" max="2000" />
                                    </div>
                                </div>
                                <div class="control-row mb-2">
                                    <button id="startAutoCalibrationBtn" class="btn btn-success" disabled>
                                        <span data-i18n="start_auto_capture">开始自动采集</span>
                                    </button>
                                    <button id="stopAutoCalibrationBtn" class="btn btn-danger" disabled>
                                        <span data-i18n="stop_auto_capture">停止采集</span>
                                    </button>
                                </div>
                                <!-- 倒计时显示区域 -->
                                <div id="countdownDisplay" class="countdown-display" style="display: none;">
                                    <div class="countdown-item">
                                        <span class="countdown-label" data-i18n="remaining_time">剩余时间:</span>
                                        <span id="remainingTime" class="countdown-value">0s</span>
                                    </div>
                                    <div class="countdown-item">
                                        <span class="countdown-label" data-i18n="next_capture_in">下次采集:</span>
                                        <span id="nextCaptureTime" class="countdown-value">0s</span>
                                    </div>
                                    <div class="countdown-item">
                                        <span class="countdown-label" data-i18n="capture_progress">采集进度:</span>
                                        <span id="captureProgress" class="countdown-value">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 标定执行和保存 -->
                            <div class="control-row mb-2">
                                <button id="performCameraCalibrationBtn" class="btn btn-success" disabled>
                                    <span data-i18n="perform_calibration">执行标定</span>
                                </button>
                                <button id="saveCameraCalibrationBtn" class="btn btn-secondary" disabled>
                                    <span data-i18n="save_calibration">保存标定</span>
                                </button>
                                <button id="loadCameraCalibrationBtn" class="btn btn-primary">
                                    <span data-i18n="load_calibration">加载标定</span>
                                </button>
                            </div>
                            
                            <!-- 相机校正控制 -->
                            <div class="control-row mb-2">
                                <div class="camera-correction-control">
                                    <label class="switch-container">
                                        <input type="checkbox" id="enableCameraCorrectionToggle" disabled>
                                        <span class="switch-slider"></span>
                                        <span class="switch-label" data-i18n="enable_camera_correction">启用相机校正</span>
                                    </label>
                                    <div id="correctionStatus" class="correction-status">
                                        <span class="status-text" data-i18n="correction_inactive">校正未激活</span>
                                    </div>
                                </div>
                            </div>
                            

                        </div>
                        

                        

                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="control-section">
                        <h3 class="mb-2" data-i18n="coordinate_transform_calibration">坐标变换标定</h3>
                        <p class="section-description" data-i18n="coordinate_calibration_desc">用于图像坐标与实际地面坐标的转换</p>
                        <div class="control-row">
                            <button id="toggleCalibrationBtn" class="btn btn-primary">
                                <span data-i18n="enter_calibration_mode">进入标定模式</span>
                            </button>
                            <button id="computeHomographyBtn" class="btn btn-success" disabled>
                                <span data-i18n="compute_homography">计算单应性矩阵</span>
                            </button>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="control-section">
                        <h3 class="mb-2" data-i18n="aruco_marker_detection">ArUco 标记检测</h3>
                        <div class="control-row">
                            <button id="toggleArUcoBtn" class="btn btn-primary">
                                <span data-i18n="enable_aruco_mode">启用 ArUco 模式</span>
                            </button>
                            <button id="calibrateFromArUcoBtn" class="btn btn-success" disabled>
                                <span data-i18n="calibrate_from_aruco">从 ArUco 标记标定</span>
                            </button>
                        </div>
                        <div class="control-row mt-2">
                            <button id="saveMarkerCoordsBtn" class="btn btn-secondary" disabled>
                                <span data-i18n="save_marker_coords">保存标记坐标</span>
                            </button>
                            <button id="loadMarkerCoordsBtn" class="btn btn-secondary">
                                <span data-i18n="load_marker_coords">加载标记坐标</span>
                            </button>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="control-section">
                        <h3 class="mb-2" data-i18n="coordinate_system">坐标系设置</h3>
                        <div class="control-row">
                            <button id="setOriginBtn" class="btn btn-primary">
                                <span data-i18n="set_origin">设置原点</span>
                            </button>
                            <button id="toggleCoordTypeBtn" class="btn btn-secondary">
                                <span data-i18n="toggle_coord_type">切换坐标类型</span>
                            </button>
                        </div>
                        <div class="coordinate-system-info mt-2">
                            <div class="info-item">
                                <span class="info-label" data-i18n="coord_type">坐标类型:</span>
                                <span id="coordTypeDisplay" class="info-value">直角坐标</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="origin_position">原点位置:</span>
                                <span id="originDisplay" class="info-value">(0, 0)</span>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="control-section">
                        <h3 class="mb-2" data-i18n="debug_information">调试信息</h3>
                        <div class="debug-panel">
                            <div class="debug-toggle">
                                <label class="switch">
                                    <input type="checkbox" id="debugToggle">
                                    <span class="slider round"></span>
                                </label>
                                <span data-i18n="show_debug_info">显示调试信息</span>
                            </div>
                            <div id="debugInfo" class="debug-info" style="display: none;">
                                <div class="info-item">
                                    <span class="info-label" data-i18n="homography_matrix">单应性矩阵:</span>
                                    <pre id="homographyMatrix" class="info-value matrix">-</pre>
                                    <button id="exportMatrixBtn" class="btn btn-sm btn-secondary">
                                        <span data-i18n="export_matrix">导出矩阵</span>
                                    </button>
                                </div>
                                <div class="info-item">
                                    <span class="info-label" data-i18n="detected_markers">检测到的标记:</span>
                                    <span id="detectedMarkersCount" class="info-value">0</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label" data-i18n="last_operation">最近操作:</span>
                                    <span id="lastOperation" class="info-value">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="calibrationPanel" class="calibration-panel" style="display: none;">
                <h3>单应性矩阵标定</h3>
                <p>点击视频添加标定点。至少需要 4 个点。</p>
                
                <div class="calibration-controls">
                    <div class="ground-coordinates">
                        <label>地面坐标 X:</label>
                        <input type="number" id="groundX" class="form-input" value="0">
                        <label>地面坐标 Y:</label>
                        <input type="number" id="groundY" class="form-input" value="0">
                    </div>
                    
                    <div class="calibration-buttons">
                        <button id="removeLastPointBtn" class="btn btn-danger">移除最后一个点</button>
                        <button id="clearPointsBtn" class="btn btn-danger">清除所有点</button>
                    </div>
                    
                    <div class="calibration-file">
                        <button id="saveCalibrationBtn" class="btn btn-success">保存标定结果</button>
                        <button id="loadCalibrationBtn" class="btn btn-primary">加载标定结果</button>
                    </div>
                </div>
                
                <div class="calibration-points">
                    <h4>标定点列表</h4>
                    <div id="pointsList"></div>
                </div>
            </div>
            
            <div id="arucoPanel" class="aruco-panel" style="display: none;">
                <h3>ArUco 标记检测</h3>
                <p>系统将自动检测视频中的 ArUco 标记。为每个标记设置地面坐标。</p>
                
                <div class="aruco-marker-settings">
                    <h4>标记坐标设置</h4>
                    <div class="form-group">
                        <label>标记 ID:</label>
                        <input type="number" id="markerId" class="form-input" min="0" max="49" value="0">
                    </div>
                    <div class="form-group">
                        <label>地面坐标 X:</label>
                        <input type="number" id="markerGroundX" class="form-input" value="0">
                    </div>
                    <div class="form-group">
                        <label>地面坐标 Y:</label>
                        <input type="number" id="markerGroundY" class="form-input" value="0">
                    </div>
                    <button id="setMarkerCoordBtn" class="btn btn-primary">设置标记坐标</button>
                </div>
                
                <div class="aruco-markers-list">
                    <h4>已设置标记列表</h4>
                    <div id="markersList" class="markers-list-container"></div>
                </div>
            </div>
            
            <div id="coordinateTestPanel" class="coordinate-test-panel" style="display: none;">
                <h3>坐标转换测试</h3>
                <p>点击视频将图像坐标转换为地面坐标。</p>
                
                <div class="coordinate-display">
                    <div>
                        <span>图像 X:</span>
                        <span id="imageX">0</span>
                    </div>
                    <div>
                        <span>图像 Y:</span>
                        <span id="imageY">0</span>
                    </div>
                    <div>
                        <span>地面 X:</span>
                        <span id="convertedGroundX">0</span>
                    </div>
                    <div>
                        <span>地面 Y:</span>
                        <span id="convertedGroundY">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 添加一些基础的调试输出
        console.log('HTML script block loaded, timestamp:', new Date().toISOString());
        console.log('Document ready state:', document.readyState);
    </script>
    
    <!-- 首先加载多语言支持 -->
    <script src="i18n.js"></script>
    <!-- 然后加载主程序 -->
    <script src="script.js"></script>
</body>
</html>
