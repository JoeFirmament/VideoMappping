# VideoMapping 高帧率性能优化日志

## 优化时间
2024年12月19日

## 平台信息
- **操作系统**: Linux 6.1.43-15-rk2312 (RK2312 ARM64架构)
- **设备**: radxa@rock-5c (8GB内存)
- **CPU类型**: ARM64 RK2312
- **工作目录**: /home/radxa/Qworkspace/VideoMapping

## 优化目标
1. 移除640x480分辨率的硬编码限制
2. 禁用自适应帧率降速机制
3. 启用高性能模式以获得更高帧率

## 具体优化内容

### 1. 移除自适应帧率降速 ✅
**文件**: `src/VideoStreamer.cpp:315-365`
**修改内容**:
- 移除了自动将FPS从25降到20的逻辑
- 移除了连续超时时进一步降低FPS的机制
- 改为使用原始FPS设置，不进行自动降速

**优化前**:
```cpp
if (fps_ > 25) {
    adaptiveFPS = 20;  // 降低目标FPS到20以提高稳定性
}
```

**优化后**:
```cpp
int targetFPS = fps_;  // 直接使用原始FPS设置
```

### 2. 精确帧率控制优化 ✅
**修改内容**:
- 优化睡眠策略：只有超过100微秒才睡眠
- 移除复杂的超时检测和警告机制
- 使用更精确的yield策略

### 3. 移除640x480硬编码 ✅
**文件**: `src/main.cpp:74`
**修改内容**:
- 将硬编码的默认分辨率改为动态获取当前分辨率
- 避免强制回退到640x480

### 4. 分辨率优先级调整 ✅
**文件**: `src/VideoStreamer.cpp:224`
**修改内容**:
- 将分辨率列表重新排序，优先支持高分辨率
- 1920x1080 Full HD 设为最高优先级
- 640x480 VGA 仅作为兼容性保留

### 5. 高性能摄像头设置 ✅
**文件**: `src/VideoStreamer.cpp:85-95`
**新增内容**:
```cpp
// 高性能优化设置
cap_.set(cv::CAP_PROP_BUFFERSIZE, 1);      // 减少缓冲区大小，降低延迟
cap_.set(cv::CAP_PROP_AUTO_EXPOSURE, 0.25); // 禁用自动曝光以提高帧率稳定性
cap_.set(cv::CAP_PROP_AUTOFOCUS, 0);       // 禁用自动对焦以减少处理时间
```

## 预期效果
1. **帧率提升**: 移除20FPS的限制，可以达到摄像头的最大支持帧率
2. **延迟降低**: 缓冲区大小减少到1，显著降低视频流延迟
3. **稳定性提升**: 禁用自动曝光和对焦，减少帧率波动
4. **分辨率优化**: 优先使用高分辨率，提供更好的图像质量

## 调试建议
1. **监控实际FPS**: 观察控制台输出的"🎯 [HIGH PERFORMANCE] Actual FPS"日志
2. **检查延迟**: 测试视频流的实时性
3. **验证分辨率**: 确认摄像头使用的实际分辨率
4. **性能监控**: 观察CPU使用率和内存占用

## 回滚方案
如果优化后出现问题，可以：
1. 恢复自适应FPS机制
2. 增加缓冲区大小到默认值
3. 重新启用自动曝光和对焦

## 版本标记
- **优化版本**: v2.1-high-performance
- **Git提交**: 建议提交时使用标签 "feat: enable high performance mode for higher FPS" 